<!-- Main Container -->
<div class="min-h-screen bg-gray-50">
  <!-- Loading Overlay -->
  <div
    *ngIf="isLoading"
    class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75"
  >
    <div class="text-center">
      <svg
        class="w-10 h-10 mx-auto mb-4 text-indigo-600 animate-spin"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <p class="font-medium text-gray-700">Loading backlog...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div
    *ngIf="errorMessage"
    class="p-4 mx-6 my-4 border border-red-200 rounded-md bg-red-50"
  >
    <div class="flex">
      <div class="flex-shrink-0">
        <svg
          class="w-5 h-5 text-red-400"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd"
          />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">Error</h3>
        <div class="mt-2 text-sm text-red-700">
          <p>{{ errorMessage }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Header with Breadcrumbs -->
  <div class="px-6 py-4 bg-white border-b border-gray-200">
    <div class="flex items-center text-sm text-gray-600">
      <a href="#" class="hover:underline">Projects</a>
      <span class="mx-2">/</span>
      <a href="#" class="hover:underline">{{ currentProjectName }}</a>
    </div>
    <div class="flex items-center justify-between mt-2">
      <h1 class="text-2xl font-semibold text-gray-900">Backlog</h1>
      <div class="flex gap-2">
        <!-- Buttons removed -->
      </div>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div
    class="flex items-center gap-2 px-6 py-3 bg-white border-b border-gray-200"
  >
    <div class="relative w-56">
      <span class="absolute inset-y-0 left-0 flex items-center pl-2">
        <svg
          class="w-5 h-5 text-gray-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </span>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Search"
        class="w-full py-2 pr-4 bg-gray-100 border border-gray-300 rounded-md pl-9 focus:ring-blue-500 focus:border-blue-500"
      />
    </div>

    <div class="flex items-center">
      <div
        class="flex items-center justify-center w-8 h-8 text-white bg-indigo-600 rounded-full"
      >
        GH
      </div>
      <div
        class="flex items-center justify-center w-8 h-8 ml-1 text-gray-600 bg-gray-100 border border-gray-300 rounded-full"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
      </div>
    </div>

    <div class="ml-4">
      <button
        class="flex items-center gap-1 px-3 py-1 text-sm font-medium text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
      >
        <span>Epic</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>
    </div>

    <div class="flex items-center gap-3 ml-auto">
      <!-- Buttons removed -->
    </div>
  </div>

  <!-- Main Backlog Content Area -->
  <div class="p-6">
    <!-- Sprint Section -->
    <div class="mb-6" *ngFor="let sprint of sprints">
      <!-- Sprint Header -->
      <div
        class="flex items-center px-4 py-3 mb-3 bg-white border border-gray-200 rounded-sm hover:bg-gray-50"
      >
        <div class="flex items-center">
          <input
            type="checkbox"
            class="w-4 h-4 mr-2 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />

          <button
            class="flex items-center text-sm font-medium text-gray-700"
            (click)="toggleSprintCollapse(sprint.id)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 mr-1 text-gray-500 transition-transform transform"
              [ngClass]="{ 'rotate-180': !isSprintCollapsed(sprint.id) }"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="mr-1 font-bold">{{ sprint.name }}</span>
            <span
              class="mr-1 text-gray-500"
              *ngIf="sprint.startDate && sprint.endDate"
            >
              {{ sprint.startDate | date : "d MMM" }} -
              {{ sprint.endDate | date : "d MMM" }}
            </span>
            <span class="text-gray-500"
              >({{ getTodoIssuesCount(sprint) }}
              {{ getTodoIssuesCount(sprint) === 1 ? "issue" : "issues" }})</span
            >
          </button>
        </div>

        <div class="flex items-center gap-2 ml-auto">
          <div class="mr-2 text-sm text-gray-600">
            <span class="font-bold">{{
              sprint.completedStoryPoints || 0
            }}</span>
          </div>

          <div class="flex items-center">
            <div
              class="flex items-center justify-center w-6 h-6 mr-1 text-xs text-white bg-blue-500 rounded-full"
            >
              {{ getTodoIssuesCount(sprint) }}
            </div>
            <div
              class="flex items-center justify-center w-6 h-6 text-xs text-white bg-green-500 rounded-full"
            >
              {{ getDoneIssuesCount(sprint) }}
            </div>
          </div>

          <button
            *ngIf="sprint.status === 'Active'"
            class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 ml-4 rounded hover:bg-gray-200"
            (click)="completeSprint(sprint.id)"
          >
            Complete sprint
          </button>

          <div class="relative">
            <button
              class="p-1.5 text-gray-500 hover:bg-gray-100 rounded ml-2"
              (click)="showSprintMenu = sprint.id"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>

            <!-- Sprint Menu Dropdown -->
            <div
              *ngIf="showSprintMenu === sprint.id"
              class="absolute right-0 z-20 w-48 py-1 mt-1 bg-white border border-gray-200 rounded-md shadow-lg"
            >
              <button
                (click)="editSprint(sprint); showSprintMenu = null"
                class="block w-full px-4 py-2 text-sm text-left text-gray-700 hover:bg-gray-100"
              >
                Edit sprint
              </button>
              <button
                (click)="deleteSprint(sprint.id); showSprintMenu = null"
                class="block w-full px-4 py-2 text-sm text-left text-red-600 hover:bg-gray-100"
              >
                Delete sprint
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sprint Issues -->
      <div
        class="mb-1 ml-6 bg-white border border-gray-200"
        [ngClass]="{ hidden: isSprintCollapsed(sprint.id) }"
        cdkDropList
        [id]="'sprint-' + sprint.id"
        [cdkDropListData]="sprint.issues"
        [cdkDropListConnectedTo]="getSprintDropTargets(sprint.id)"
        (cdkDropListDropped)="drop($event)"
      >
        <div
          *ngFor="let issue of getFilteredIssues(sprint.issues)"
          cdkDrag
          class="flex items-center p-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-50"
          (click)="openIssueDetail(issue)"
        >
          <div class="flex-shrink-0 mr-3">
            <input
              type="checkbox"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              [checked]="issue.status === 'Done'"
              (click)="$event.stopPropagation()"
            />
          </div>

          <div class="flex-shrink-0 mr-3">
            <svg
              *ngIf="issue.type === 'Task'"
              class="w-4 h-4 text-blue-600"
              viewBox="0 0 16 16"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033a.5.5 0 0 1 .707 0L9 8.83l.146-.147a.5.5 0 0 1 .707.707l-.853.853a.5.5 0 0 1-.707 0L6 7.707a.5.5 0 0 1 0-.707z"
              />
            </svg>
            <svg
              *ngIf="issue.type === 'Bug'"
              class="w-4 h-4 text-red-600"
              viewBox="0 0 16 16"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4.355.522a.5.5 0 0 1 .623.333l.291.956A5 5 0 0 1 8 1c1.007 0 1.946.298 2.731.811l.29-.956a.5.5 0 1 1 .957.29l-.41 1.352A5 5 0 0 1 13 7h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H13a5 5 0 0 1-6.257 4.838l-.29.956a.5.5 0 0 1-.957-.29l.41-1.352A5 5 0 0 1 3 8H2a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 2 6h1a5 5 0 0 1 1.09-3.132L3.8.522a.5.5 0 0 1 .554-.832z"
              />
            </svg>
          </div>

          <div class="flex-grow">
            <div class="flex items-center">
              <span class="mr-2 font-medium text-blue-600">{{
                issue.key
              }}</span>
              <span class="text-gray-700">{{ issue.title }}</span>
            </div>
          </div>

          <div class="flex items-center ml-auto">
            <div class="relative inline-block mr-2 text-left">
              <button
                class="flex items-center px-3 py-1 text-xs font-medium transition-colors duration-150 rounded-sm"
                [ngClass]="{
                  'bg-blue-100 text-blue-800 hover:bg-blue-200':
                    issue.status === 'To Do',
                  'bg-yellow-100 text-yellow-800 hover:bg-yellow-200':
                    issue.status === 'In Progress',
                  'bg-purple-100 text-purple-800 hover:bg-purple-200':
                    issue.status === 'Review',
                  'bg-green-100 text-green-800 hover:bg-green-200':
                    issue.status === 'Done'
                }"
                (click)="$event.stopPropagation()"
              >
                <span
                  class="inline-block w-2 h-2 mr-1.5 rounded-full"
                  [ngClass]="{
                    'bg-blue-500': issue.status === 'To Do',
                    'bg-yellow-500': issue.status === 'In Progress',
                    'bg-purple-500': issue.status === 'Review',
                    'bg-green-500': issue.status === 'Done',
                    'bg-gray-500': !issue.status
                  }"
                ></span>
                <span>{{ issue.status }}</span>
                <div class="relative inline-block ml-1">
                  <button
                    class="inline-flex text-gray-500 hover:text-gray-700"
                    (click)="toggleStatusDropdown($event, issue.id)"
                  >
                    <svg
                      class="w-3 h-3"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                  <div
                    class="absolute right-0 z-50 w-40 mt-1 origin-top-right bg-white border border-gray-200 divide-y divide-gray-100 rounded-md shadow-lg"
                    [ngClass]="{ hidden: !isStatusDropdownOpen(issue.id) }"
                    (click)="$event.stopPropagation()"
                  >
                    <div class="py-1">
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'To Do');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-blue-500 rounded-full"
                        ></span>
                        To Do
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'In Progress');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-yellow-500 rounded-full"
                        ></span>
                        In Progress
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'Review');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-purple-500 rounded-full"
                        ></span>
                        Review
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'Done');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-green-500 rounded-full"
                        ></span>
                        Done
                      </button>
                    </div>
                  </div>
                </div>
              </button>
            </div>

            <div
              *ngIf="issue.assignee"
              class="flex items-center justify-center mr-2 bg-gray-200 rounded-full w-7 h-7"
            >
              <span class="text-xs text-gray-600">{{
                issue.assignee && issue.assignee.name
                  ? issue.assignee.name.charAt(0)
                  : "U"
              }}</span>
            </div>

            <button class="p-1 mr-2 text-gray-400 hover:text-gray-700">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Create Issue Button -->
        <div class="flex items-center p-3 border-t border-gray-200 bg-gray-50">
          <button
            class="flex items-center text-sm text-gray-600 hover:text-gray-900"
            (click)="showCreateIssueModal = true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 mr-1"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                clip-rule="evenodd"
              />
            </svg>
            Create issue
          </button>
        </div>
      </div>
    </div>

    <!-- Backlog Section -->
    <div class="mb-6">
      <!-- Backlog Header -->
      <div
        class="flex items-center px-4 py-3 mb-3 bg-white border border-gray-200 rounded-sm hover:bg-gray-50"
      >
        <div class="flex items-center">
          <input
            type="checkbox"
            class="w-4 h-4 mr-2 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />

          <button
            class="flex items-center text-sm font-medium text-gray-700"
            (click)="toggleBacklogCollapse()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 mr-1 text-gray-500 transition-transform transform"
              [ngClass]="{ 'rotate-180': !isBacklogCollapsed }"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="mr-1 font-bold">Backlog</span>
            <span class="text-gray-500"
              >({{ getBacklogTodoIssuesCount() }}
              {{
                getBacklogTodoIssuesCount() === 1 ? "issue" : "issues"
              }})</span
            >
          </button>
        </div>

        <div class="flex items-center gap-2 ml-auto">
          <div class="mr-2 text-sm text-gray-600">
            <span class="font-bold">{{ backlogIssues.length }}</span>
          </div>

          <div class="flex items-center">
            <div
              class="flex items-center justify-center w-6 h-6 mr-1 text-xs text-white bg-blue-500 rounded-full"
            >
              {{ getBacklogTodoIssuesCount() }}
            </div>
            <div
              class="flex items-center justify-center w-6 h-6 text-xs text-white bg-green-500 rounded-full"
            >
              {{ getBacklogDoneIssuesCount() }}
            </div>
          </div>

          <button
            class="px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 ml-4 rounded hover:bg-blue-200"
            (click)="showCreateSprintModal = true"
          >
            Create sprint
          </button>

          <button class="ml-2">
            <svg
              class="w-6 h-6 text-gray-400"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 6V12M12 12V18M12 12H18M12 12H6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>

          <button class="p-1.5 text-gray-500 hover:bg-gray-100 rounded ml-1">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="12" cy="5" r="1"></circle>
              <circle cx="12" cy="19" r="1"></circle>
            </svg>
          </button>
        </div>
      </div>

      <!-- Backlog Issues Container -->
      <div
        class="ml-6 bg-white border border-gray-200"
        [ngClass]="{ hidden: isBacklogCollapsed }"
        cdkDropList
        id="backlog"
        [cdkDropListData]="backlogIssues"
        (cdkDropListDropped)="drop($event)"
        [cdkDropListConnectedTo]="connectedDropLists"
      >
        <div
          *ngIf="backlogIssues.length === 0"
          class="flex items-center justify-center p-8 m-3 text-gray-500 border-2 border-gray-200 border-dashed"
        >
          Your backlog is empty.
        </div>

        <div
          *ngFor="let issue of getFilteredIssues(backlogIssues)"
          cdkDrag
          class="flex items-center p-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-50"
          (click)="openIssueDetail(issue); closeAllDropdowns()"
        >
          <div class="flex-shrink-0 mr-3">
            <input
              type="checkbox"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              [checked]="issue.status === 'Done'"
              (click)="$event.stopPropagation()"
            />
          </div>

          <div class="flex-shrink-0 mr-3">
            <svg
              *ngIf="issue.type === 'Task'"
              class="w-4 h-4 text-blue-600"
              viewBox="0 0 16 16"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033a.5.5 0 0 1 .707 0L9 8.83l.146-.147a.5.5 0 0 1 .707.707l-.853.853a.5.5 0 0 1-.707 0L6 7.707a.5.5 0 0 1 0-.707z"
              />
            </svg>
            <svg
              *ngIf="issue.type === 'Bug'"
              class="w-4 h-4 text-red-600"
              viewBox="0 0 16 16"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4.355.522a.5.5 0 0 1 .623.333l.291.956A5 5 0 0 1 8 1c1.007 0 1.946.298 2.731.811l.29-.956a.5.5 0 1 1 .957.29l-.41 1.352A5 5 0 0 1 13 7h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H13a5 5 0 0 1-6.257 4.838l-.29.956a.5.5 0 0 1-.957-.29l.41-1.352A5 5 0 0 1 3 8H2a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 2 6h1a5 5 0 0 1 1.09-3.132L3.8.522a.5.5 0 0 1 .554-.832z"
              />
            </svg>
          </div>

          <div class="flex-grow">
            <div class="flex items-center">
              <span class="mr-2 font-medium text-blue-600">{{
                issue.key
              }}</span>
              <span class="text-gray-700">{{ issue.title }}</span>
            </div>
          </div>

          <div class="flex items-center ml-auto">
            <div class="relative inline-block mr-2 text-left">
              <button
                class="flex items-center px-3 py-1 text-xs font-medium transition-colors duration-150 rounded-sm"
                [ngClass]="{
                  'bg-blue-100 text-blue-800 hover:bg-blue-200':
                    issue.status === 'To Do',
                  'bg-yellow-100 text-yellow-800 hover:bg-yellow-200':
                    issue.status === 'In Progress',
                  'bg-purple-100 text-purple-800 hover:bg-purple-200':
                    issue.status === 'Review',
                  'bg-green-100 text-green-800 hover:bg-green-200':
                    issue.status === 'Done'
                }"
                (click)="$event.stopPropagation()"
              >
                <span
                  class="inline-block w-2 h-2 mr-1.5 rounded-full"
                  [ngClass]="{
                    'bg-blue-500': issue.status === 'To Do',
                    'bg-yellow-500': issue.status === 'In Progress',
                    'bg-purple-500': issue.status === 'Review',
                    'bg-green-500': issue.status === 'Done',
                    'bg-gray-500': !issue.status
                  }"
                ></span>
                <span>{{ issue.status }}</span>
                <div class="relative inline-block ml-1">
                  <button
                    class="inline-flex text-gray-500 hover:text-gray-700"
                    (click)="toggleStatusDropdown($event, issue.id)"
                  >
                    <svg
                      class="w-3 h-3"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                  <div
                    class="absolute right-0 z-50 w-40 mt-1 origin-top-right bg-white border border-gray-200 divide-y divide-gray-100 rounded-md shadow-lg"
                    [ngClass]="{ hidden: !isStatusDropdownOpen(issue.id) }"
                    (click)="$event.stopPropagation()"
                  >
                    <div class="py-1">
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'To Do');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-blue-500 rounded-full"
                        ></span>
                        To Do
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'In Progress');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-yellow-500 rounded-full"
                        ></span>
                        In Progress
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'Review');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-purple-500 rounded-full"
                        ></span>
                        Review
                      </button>
                      <button
                        class="flex items-center w-full px-4 py-2 text-xs text-left hover:bg-gray-100"
                        (click)="
                          quickUpdateStatus($event, issue, 'Done');
                          closeAllDropdowns()
                        "
                      >
                        <span
                          class="inline-block w-2 h-2 mr-2 bg-green-500 rounded-full"
                        ></span>
                        Done
                      </button>
                    </div>
                  </div>
                </div>
              </button>
            </div>

            <div
              *ngIf="issue.assignee"
              class="flex items-center justify-center mr-2 bg-gray-200 rounded-full w-7 h-7"
            >
              <span class="text-xs text-gray-600">{{
                issue.assignee && issue.assignee.name
                  ? issue.assignee.name.charAt(0)
                  : "U"
              }}</span>
            </div>

            <button class="p-1 mr-2 text-gray-400 hover:text-gray-700">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Create Issue Button -->
        <div class="flex items-center p-3 border-t border-gray-200 bg-gray-50">
          <button
            class="flex items-center text-sm text-gray-600 hover:text-gray-900"
            (click)="showCreateIssueModal = true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 mr-1"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                clip-rule="evenodd"
              />
            </svg>
            Create issue
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Issue Detail Sidebar -->
  <div
    *ngIf="selectedIssue"
    class="fixed top-0 right-0 w-[500px] h-full bg-white border-l border-gray-200 shadow-lg z-50 overflow-y-auto"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <div class="flex items-center">
        <button
          class="p-1 mr-2 text-gray-500 hover:text-gray-700"
          (click)="closeIssueDetail()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <div class="flex items-center">
          <span class="text-sm font-medium text-gray-800">{{
            selectedIssue.key
          }}</span>
          <button class="p-1 ml-2 text-gray-500 hover:text-gray-700">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path
                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="flex items-center">
        <button class="p-1.5 text-gray-500 hover:text-gray-700">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"
            ></path>
          </svg>
        </button>

        <button class="p-1.5 text-gray-500 hover:text-gray-700">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M8.56 2.9A7 7 0 0 1 19 9v4m-2 4H2v-7a2 2 0 0 1 2-2h9.5M6 18v3m4-3v3m4-3v3"
            ></path>
          </svg>
        </button>

        <button class="p-1.5 text-gray-500 hover:text-gray-700">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M18 21l-7-7M3 21l7-7M21 7v1.5M21 13v1.5M21 19v1.5M3 13v1.5M3 7v1.5M3 19v1.5"
            ></path>
          </svg>
        </button>

        <button class="p-1.5 text-gray-500 hover:text-gray-700">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="19" cy="12" r="1"></circle>
            <circle cx="5" cy="12" r="1"></circle>
          </svg>
        </button>
      </div>
    </div>

    <!-- Title -->
    <div class="p-4 border-b border-gray-200">
      <div *ngIf="!isEditingTitle" class="flex items-start">
        <div [ngSwitch]="selectedIssue.type" class="flex-shrink-0 mr-3">
          <svg
            *ngSwitchCase="'Task'"
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 text-blue-600"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"
            />
          </svg>
          <svg
            *ngSwitchCase="'Bug'"
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 text-red-600"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L16.9 4H20V2H13.9l-2-2h-3.8l-2 2H4v2h3.1l1.52 2.04c-.75.51-1.37 1.18-1.82 1.96H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-4 4v3c0 .22-.03.47-.07.7l-.1.65-.37.65c-.72 1.24-2.04 2-3.46 2s-2.74-.77-3.46-2l-.37-.64-.1-.65C8.03 15.48 8 15.23 8 15v-4c0-.23.03-.48.07-.7l.1-.65.37-.65c.3-.52.72-.97 1.21-1.31l.57-.39.74-.18c.31-.08.63-.12.94-.12.32 0 .63.04.95.12l.68.16.61.42c.5.34.91.78 1.21 1.31l.38.65.1.65c.04.22.07.47.07.69v1zm-6 2h4v2h-4v-2zm0-8h4v2h-4V6z"
            />
          </svg>
        </div>

        <div class="flex-grow">
          <h2 class="text-xl font-medium text-gray-800">
            {{ selectedIssue.title }}
          </h2>
          <button
            class="mt-1 text-sm text-blue-600 hover:underline"
            (click)="startEditingTitle()"
          >
            Edit
          </button>
        </div>
      </div>

      <div *ngIf="isEditingTitle" class="mt-2">
        <textarea
          [(ngModel)]="editingIssue.title"
          class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          rows="2"
        ></textarea>
        <div class="flex mt-2 space-x-2">
          <button
            class="px-3 py-1 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700"
            (click)="saveTitle()"
          >
            Save
          </button>
          <button
            class="px-3 py-1 text-sm text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
            (click)="cancelEditingTitle()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Actions Bar -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center text-sm">
        <button
          class="px-3 py-1 font-medium text-gray-700 rounded-md hover:bg-gray-100"
        >
          Add child â–¾
        </button>
        <div class="w-px h-4 mx-3 bg-gray-300"></div>
        <button
          class="px-3 py-1 font-medium text-gray-700 rounded-md hover:bg-gray-100"
        >
          Link issue
        </button>
        <div class="w-px h-4 mx-3 bg-gray-300"></div>
        <button
          class="px-3 py-1 font-medium text-red-600 rounded-md hover:bg-red-50"
          (click)="deleteIssue()"
        >
          Delete
        </button>
      </div>
    </div>

    <!-- Details Section -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-800">Details</h3>
        <button class="text-gray-500 hover:text-gray-700">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
      </div>

      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <div class="mb-3">
            <label class="block mb-1 text-gray-500">Reporter</label>
            <div class="flex items-center">
              <div class="flex-shrink-0 mr-2">
                <div
                  *ngIf="
                    selectedIssue &&
                    selectedIssue.reporter &&
                    selectedIssue.reporter.name
                  "
                  class="flex items-center justify-center text-sm font-medium text-white bg-purple-600 rounded-full w-7 h-7"
                >
                  {{ getInitials(selectedIssue.reporter.name) }}
                </div>
                <div
                  *ngIf="
                    !selectedIssue ||
                    !selectedIssue.reporter ||
                    !selectedIssue.reporter.name
                  "
                  class="flex items-center justify-center text-sm font-medium text-white bg-gray-400 rounded-full w-7 h-7"
                >
                  ?
                </div>
              </div>
              <div>
                <span class="font-medium text-gray-800">{{
                  selectedIssue &&
                  selectedIssue.reporter &&
                  selectedIssue.reporter.name
                    ? selectedIssue.reporter.name
                    : "Unassigned"
                }}</span>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="block mb-1 text-gray-500">Priority</label>
            <select
              [(ngModel)]="editingIssue.priority"
              (change)="
                editingIssue.priority &&
                  (selectedIssue.priority = editingIssue.priority)
              "
              class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="Highest">Highest</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
              <option value="Lowest">Lowest</option>
            </select>
          </div>
        </div>

        <div>
          <div class="mb-3">
            <label class="block mb-1 text-gray-500">Assignee</label>

            <!-- Assignee dropdown trigger -->
            <div class="relative">
              <div
                class="flex items-center p-2 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50"
                (click)="toggleAssigneeDropdown($event)"
              >
                <div class="flex-shrink-0 mr-2">
                  <div
                    *ngIf="
                      selectedIssue &&
                      selectedIssue.assignee &&
                      selectedIssue.assignee.name
                    "
                    class="flex items-center justify-center text-sm font-medium text-white bg-blue-600 rounded-full w-7 h-7"
                  >
                    {{ getInitials(selectedIssue.assignee.name) }}
                  </div>
                  <div
                    *ngIf="
                      !selectedIssue ||
                      !selectedIssue.assignee ||
                      !selectedIssue.assignee.name
                    "
                    class="flex items-center justify-center text-sm font-medium text-gray-600 bg-gray-200 rounded-full w-7 h-7"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </div>
                </div>
                <div class="flex-grow">
                  <span class="font-medium text-gray-800">
                    {{
                      selectedIssue &&
                      selectedIssue.assignee &&
                      selectedIssue.assignee.name
                        ? selectedIssue.assignee.name
                        : "Unassigned"
                    }}
                  </span>
                </div>
                <div class="flex-shrink-0 ml-2">
                  <svg
                    class="w-5 h-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
              </div>

              <!-- Dropdown content -->
              <div
                *ngIf="showAssigneeDropdown"
                class="absolute left-0 z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg"
              >
                <!-- Unassigned option -->
                <div
                  class="flex items-center p-2 cursor-pointer hover:bg-gray-100"
                  (click)="unassignIssue(); toggleAssigneeDropdown($event)"
                >
                  <div class="flex-shrink-0 mr-2">
                    <div
                      class="flex items-center justify-center text-sm font-medium text-gray-600 bg-gray-200 rounded-full w-7 h-7"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-grow">
                    <span class="font-medium text-gray-800">Unassigned</span>
                  </div>
                </div>

                <!-- Current user with "Assign to me" option -->
                <div
                  class="flex items-center p-2 cursor-pointer hover:bg-gray-100"
                  (click)="assignToMe(); toggleAssigneeDropdown($event)"
                >
                  <div class="flex-shrink-0 mr-2">
                    <div
                      class="flex items-center justify-center text-sm font-medium text-white bg-purple-600 rounded-full w-7 h-7"
                    >
                      {{ currentUserInitials }}
                    </div>
                  </div>
                  <div class="flex-grow">
                    <span class="font-medium text-gray-800">{{
                      currentUserName
                    }}</span>
                    <span class="ml-2 text-sm text-gray-500"
                      >(Assign to me)</span
                    >
                  </div>
                </div>

                <!-- Automatic option -->
                <div
                  class="flex items-center p-2 cursor-pointer hover:bg-gray-100"
                  (click)="assignAutomatic(); toggleAssigneeDropdown($event)"
                >
                  <div class="flex-shrink-0 mr-2">
                    <div
                      class="flex items-center justify-center text-sm font-medium text-gray-600 bg-gray-200 rounded-full w-7 h-7"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-grow">
                    <span class="font-medium text-gray-800">Automatic</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="block mb-1 text-gray-500">Status</label>
            <div class="relative">
              <select
                [(ngModel)]="editingIssue.status"
                (ngModelChange)="updateIssueStatus($event)"
                class="w-full p-2 pl-10 border border-gray-300 rounded-md appearance-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="To Do">To Do</option>
                <option value="In Progress">In Progress</option>
                <option value="Review">Review</option>
                <option value="Done">Done</option>
              </select>
              <div
                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
              >
                <span
                  class="flex w-5 h-5 rounded-full"
                  [ngClass]="{
                    'bg-blue-500': editingIssue.status === 'To Do',
                    'bg-yellow-500': editingIssue.status === 'In Progress',
                    'bg-purple-500': editingIssue.status === 'Review',
                    'bg-green-500': editingIssue.status === 'Done',
                    'bg-gray-500': !editingIssue.status
                  }"
                ></span>
              </div>
              <div
                class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none"
              >
                <svg
                  class="w-5 h-5 text-gray-400"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
            </div>
            <div class="mt-2 text-xs text-gray-500">
              <div class="flex items-center">
                <span
                  class="w-2 h-2 mr-1 rounded-full"
                  [ngClass]="getStatusColor(editingIssue.status)"
                ></span>
                Any status change is updated immediately
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Section -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-medium text-gray-800">Description</h3>
      </div>

      <div *ngIf="!isEditingDescription">
        <div
          *ngIf="selectedIssue.description"
          class="prose text-gray-700 max-w-none"
        >
          {{ selectedIssue.description }}
        </div>
        <div *ngIf="!selectedIssue.description" class="italic text-gray-500">
          No description provided
        </div>
        <button
          class="mt-2 text-sm text-blue-600 hover:underline"
          (click)="startEditingDescription()"
        >
          Edit
        </button>
      </div>

      <div *ngIf="isEditingDescription" class="mt-2">
        <textarea
          [(ngModel)]="editingIssue.description"
          class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          rows="4"
        ></textarea>
        <div class="flex mt-2 space-x-2">
          <button
            class="px-3 py-1 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700"
            (click)="saveDescriptionOnly()"
          >
            Save
          </button>
          <button
            class="px-3 py-1 text-sm text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
            (click)="cancelEditingDescription()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Activity Section -->
    <div class="p-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-800">Activity</h3>
        <div class="flex items-center">
          <button
            class="px-3 py-1 text-sm text-gray-700 rounded-md hover:bg-gray-100"
            (click)="toggleCommentSortOrder()"
          >
            {{
              commentSortOrder === "newest"
                ? "Newest first â–¾"
                : "Oldest first â–¾"
            }}
          </button>
        </div>
      </div>

      <!-- Comment input form -->
      <div class="flex mt-4">
        <div class="flex-shrink-0 mr-4">
          <div
            class="flex items-center justify-center w-8 h-8 text-white bg-indigo-600 rounded-full"
          >
            {{ currentUserInitials }}
          </div>
        </div>

        <div class="flex-grow">
          <textarea
            placeholder="Add a comment..."
            [(ngModel)]="newCommentContent"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            rows="2"
          ></textarea>

          <div
            class="flex items-center justify-between mt-2 text-sm text-gray-500"
          >
            <div>
              <span>Press M to comment</span>
            </div>
            <button
              class="px-3 py-1 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
              (click)="addComment()"
              [disabled]="!newCommentContent.trim() || isLoadingComments"
            >
              Comment
            </button>
          </div>
        </div>
      </div>

      <!-- Comments list -->
      <div class="mt-6">
        <div *ngIf="isLoadingComments" class="py-4 text-center">
          <span class="text-gray-500">Loading comments...</span>
        </div>

        <div
          *ngIf="!isLoadingComments && comments.length === 0"
          class="py-4 text-center"
        >
          <span class="text-gray-500"
            >No comments yet. Be the first to comment!</span
          >
        </div>

        <div
          *ngFor="let comment of comments"
          class="py-4 border-t border-gray-200 first:border-t-0"
        >
          <div class="flex">
            <!-- User avatar -->
            <div class="flex-shrink-0 mr-4">
              <div
                class="flex items-center justify-center w-8 h-8 text-white bg-indigo-600 rounded-full"
                [ngStyle]="{
                  'background-color':
                    comment.userId === userService.getCurrentUserId()
                      ? '#4f46e5'
                      : '#9333ea'
                }"
              >
                {{
                  comment.user
                    ? getInitials(
                        comment.user.firstName + " " + comment.user.lastName
                      )
                    : "?"
                }}
              </div>
            </div>

            <!-- Comment content -->
            <div class="flex-grow">
              <div class="flex items-center">
                <h4 class="text-sm font-semibold text-gray-900">
                  {{
                    comment.user
                      ? comment.user.firstName + " " + comment.user.lastName
                      : "Unknown user"
                  }}
                </h4>
                <span class="ml-2 text-xs text-gray-500">
                  {{ comment.createdAt | date : "MMM d, y, h:mm a" }}
                </span>
              </div>

              <!-- View mode -->
              <div *ngIf="editingCommentId !== comment.id" class="mt-1">
                <p class="text-sm text-gray-700">{{ comment.content }}</p>

                <!-- Actions for own comments only -->
                <div
                  *ngIf="comment.userId === userService.getCurrentUserId()"
                  class="mt-2"
                >
                  <button
                    class="mr-3 text-xs text-blue-600 hover:underline"
                    (click)="startEditingComment(comment)"
                  >
                    Edit
                  </button>
                  <button
                    class="text-xs text-red-600 hover:underline"
                    (click)="deleteComment(comment.id)"
                  >
                    Delete
                  </button>
                </div>
              </div>

              <!-- Edit mode -->
              <div *ngIf="editingCommentId === comment.id" class="mt-1">
                <textarea
                  [(ngModel)]="editingCommentContent"
                  class="w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                  rows="3"
                ></textarea>
                <div class="flex mt-2 space-x-2">
                  <button
                    class="px-2 py-1 text-xs text-white bg-blue-600 rounded-md hover:bg-blue-700"
                    (click)="saveComment(comment.id)"
                    [disabled]="!editingCommentContent.trim()"
                  >
                    Save
                  </button>
                  <button
                    class="px-2 py-1 text-xs text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
                    (click)="cancelEditingComment()"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Issue Modal -->
  <div
    *ngIf="showCreateIssueModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-gray-600 bg-opacity-50"
  >
    <div
      class="w-full max-w-md mx-4 overflow-hidden bg-white rounded-lg shadow-lg"
    >
      <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <h3 class="text-lg font-medium text-gray-900">Create Issue</h3>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="issueType"
            >Issue Type</label
          >
          <select
            id="issueType"
            [(ngModel)]="newIssue.type"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="Epic">Epic</option>
            <option value="Story">Story</option>
            <option value="Task">Task</option>
            <option value="Bug">Bug</option>
            <option value="Sub-task">Sub-task</option>
          </select>
        </div>

        <div class="mb-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="issueTitle"
            >Summary <span class="text-red-500">*</span></label
          >
          <input
            type="text"
            id="issueTitle"
            [(ngModel)]="newIssue.title"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Issue summary"
          />
        </div>
        <div class="mb-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="issueDescription"
            >Description</label
          >
          <textarea
            id="issueDescription"
            [(ngModel)]="newIssue.description"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            rows="3"
            placeholder="Describe the issue..."
          ></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label
              class="block mb-1 text-sm font-medium text-gray-700"
              for="issuePriority"
              >Priority</label
            >
            <select
              id="issuePriority"
              [(ngModel)]="newIssue.priority"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="Highest">Highest</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
              <option value="Lowest">Lowest</option>
            </select>
          </div>
          <div>
            <label
              class="block mb-1 text-sm font-medium text-gray-700"
              for="storyPoints"
              >Story Points</label
            >
            <input
              type="number"
              id="storyPoints"
              [(ngModel)]="newIssue.storyPoints"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              min="0"
              max="100"
            />
          </div>
        </div>
        <div class="mt-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="sprintSelect"
            >Sprint</label
          >
          <select
            id="sprintSelect"
            [(ngModel)]="newIssue.sprintId"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option [ngValue]="undefined">Backlog</option>
            <option *ngFor="let sprint of sprints" [value]="sprint.id">
              {{ sprint.name }}
            </option>
          </select>
        </div>
      </div>
      <div
        class="flex justify-end px-6 py-4 border-t border-gray-200 bg-gray-50"
      >
        <button
          type="button"
          (click)="showCreateIssueModal = false"
          class="px-4 py-2 mr-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="createIssue()"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          [disabled]="!newIssue.title"
        >
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Create Sprint Modal -->
  <div
    *ngIf="showCreateSprintModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-gray-600 bg-opacity-50"
  >
    <div
      class="w-full max-w-md mx-4 overflow-hidden bg-white rounded-lg shadow-lg"
    >
      <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <h3 class="text-lg font-medium text-gray-900">
          {{ isEditingExistingSprint ? "Edit Sprint" : "Create Sprint" }}
        </h3>
      </div>
      <div class="p-6">
        <!-- Error message display -->
        <div
          *ngIf="errorMessage"
          class="p-3 mb-4 text-red-700 bg-red-100 rounded-md"
        >
          <p class="text-sm">{{ errorMessage }}</p>
        </div>

        <div class="mb-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="sprintName"
            >Sprint Name <span class="text-red-500">*</span></label
          >
          <input
            type="text"
            id="sprintName"
            [(ngModel)]="newSprint.name"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="e.g. SCRUM Sprint 1"
            [disabled]="isLoading"
          />
        </div>

        <div class="mb-4">
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="sprintGoal"
            >Sprint Goal</label
          >
          <textarea
            id="sprintGoal"
            [(ngModel)]="newSprint.goal"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="What do you want to achieve in this sprint?"
            rows="2"
            [disabled]="isLoading"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label
              class="block mb-1 text-sm font-medium text-gray-700"
              for="startDate"
              >Start Date <span class="text-red-500">*</span></label
            >
            <input
              type="date"
              id="startDate"
              [value]="getDateForInput(newSprint.startDate)"
              (change)="onStartDateChange($event)"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              [disabled]="isLoading"
            />
          </div>
          <div>
            <label
              class="block mb-1 text-sm font-medium text-gray-700"
              for="endDate"
              >End Date <span class="text-red-500">*</span></label
            >
            <input
              type="date"
              id="endDate"
              [value]="getDateForInput(newSprint.endDate)"
              (change)="onEndDateChange($event)"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              [disabled]="isLoading"
            />
          </div>
        </div>
        <div>
          <label
            class="block mb-1 text-sm font-medium text-gray-700"
            for="sprintStatus"
            >Status</label
          >
          <select
            id="sprintStatus"
            [(ngModel)]="newSprint.status"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            [disabled]="isLoading"
          >
            <option value="Planning">Planning</option>
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
          </select>
        </div>

        <!-- Board ID info if available -->
        <div *ngIf="currentBoardId" class="mt-4">
          <p class="text-xs text-gray-500">Board ID: {{ currentBoardId }}</p>
        </div>
      </div>
      <div
        class="flex justify-end px-6 py-4 border-t border-gray-200 bg-gray-50"
      >
        <button
          type="button"
          (click)="
            showCreateSprintModal = false;
            isEditingExistingSprint = false;
            resetSprintForm()
          "
          class="px-4 py-2 mr-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          [disabled]="isLoading"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="createSprint()"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          [disabled]="!newSprint.name || isLoading"
        >
          <span *ngIf="isLoading" class="mr-2">
            <svg
              class="w-4 h-4 mr-2 -ml-1 text-white animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </span>
          {{
            isLoading
              ? isEditingExistingSprint
                ? "Updating..."
                : "Creating..."
              : isEditingExistingSprint
              ? "Update"
              : "Create"
          }}
        </button>
      </div>
    </div>
  </div>
</div>
